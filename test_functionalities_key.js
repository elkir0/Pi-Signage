const puppeteer = require('puppeteer');
const fs = require('fs');
const path = require('path');

(async () => {
  const browser = await puppeteer.launch({
    headless: 'new',
    defaultViewport: { width: 1920, height: 1080 },
    args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage', '--disable-gpu']
  });

  const page = await browser.newPage();

  const screenshotsDir = '/opt/pisignage/screenshots';
  if (!fs.existsSync(screenshotsDir)) {
    fs.mkdirSync(screenshotsDir, { recursive: true });
  }

  const results = {
    timestamp: new Date().toISOString(),
    url: 'http://192.168.1.103/',
    keyFunctionalities: [],
    uploads: [],
    playerControls: [],
    playlists: [],
    systemActions: [],
    errors: []
  };

  console.log('üéØ Test 4: Fonctionnalit√©s Cl√©s PiSignage');
  console.log('URL:', 'http://192.168.1.103/');

  try {
    // Test 1: Interface Upload
    console.log('\nüì§ Test 1: Interface Upload...');

    await page.goto('http://192.168.1.103/', { waitUntil: 'networkidle2' });
    await new Promise(resolve => setTimeout(resolve, 2000));

    // Naviguer vers section M√©dias
    try {
      await page.evaluate(() => {
        const links = Array.from(document.querySelectorAll('a, button'));
        const mediaLink = links.find(link =>
          link.textContent.toLowerCase().includes('m√©dia') ||
          link.textContent.toLowerCase().includes('media')
        );
        if (mediaLink) mediaLink.click();
      });

      await new Promise(resolve => setTimeout(resolve, 2000));

      // Chercher les √©l√©ments d'upload
      const uploadElements = await page.evaluate(() => {
        const inputs = Array.from(document.querySelectorAll('input[type="file"], input[type="url"], button'));
        return inputs.map(el => ({
          type: el.type || el.tagName,
          text: el.textContent || el.placeholder || el.value || '',
          id: el.id,
          name: el.name,
          className: el.className
        })).filter(el =>
          el.text.toLowerCase().includes('upload') ||
          el.text.toLowerCase().includes('fichier') ||
          el.text.toLowerCase().includes('url') ||
          el.type === 'file'
        );
      });

      console.log(`üìÅ ${uploadElements.length} √©l√©ments d'upload trouv√©s:`);
      uploadElements.forEach((el, i) => {
        console.log(`   ${i+1}. ${el.type}: "${el.text}" (${el.id || el.className})`);
      });

      // Test upload par URL
      try {
        const urlInput = await page.$('input[type="url"], input[placeholder*="URL"], input[placeholder*="url"]');
        if (urlInput) {
          await urlInput.type('https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4');
          console.log('   ‚úÖ URL de test saisie');

          // Chercher bouton t√©l√©charger
          const downloadBtn = await page.$('button:contains("T√©l√©charger"), button:contains("Download")');
          if (downloadBtn) {
            await downloadBtn.click();
            console.log('   üîÑ Bouton t√©l√©charger cliqu√©');
            await new Promise(resolve => setTimeout(resolve, 3000));
          }
        }
      } catch (urlError) {
        console.log(`   ‚ùå Test URL: ${urlError.message}`);
      }

      // Screenshot de la section upload
      await page.screenshot({
        path: path.join(screenshotsDir, '09_upload_interface.png'),
        fullPage: true
      });

      results.uploads.push({
        name: 'Interface Upload',
        elementsFound: uploadElements.length,
        screenshot: '09_upload_interface.png',
        status: uploadElements.length > 0 ? 'SUCCESS' : 'LIMITED'
      });

    } catch (uploadError) {
      console.log(`‚ùå Erreur section upload: ${uploadError.message}`);
      results.errors.push(`Upload: ${uploadError.message}`);
    }

    // Test 2: Contr√¥les Lecteur
    console.log('\n‚ñ∂Ô∏è Test 2: Contr√¥les Lecteur...');

    try {
      await page.goto('http://192.168.1.103/', { waitUntil: 'networkidle2' });
      await new Promise(resolve => setTimeout(resolve, 1000));

      // Naviguer vers section Lecteur
      await page.evaluate(() => {
        const links = Array.from(document.querySelectorAll('a, button'));
        const playerLink = links.find(link =>
          link.textContent.toLowerCase().includes('lecteur') ||
          link.textContent.toLowerCase().includes('player')
        );
        if (playerLink) playerLink.click();
      });

      await new Promise(resolve => setTimeout(resolve, 2000));

      // Identifier contr√¥les lecteur
      const playerControls = await page.$$eval('button', buttons =>
        buttons.map(btn => ({
          text: btn.textContent.trim(),
          id: btn.id,
          className: btn.className,
          disabled: btn.disabled
        })).filter(btn =>
          btn.text.toLowerCase().includes('d√©marrer') ||
          btn.text.toLowerCase().includes('arr√™ter') ||
          btn.text.toLowerCase().includes('play') ||
          btn.text.toLowerCase().includes('stop') ||
          btn.text.toLowerCase().includes('pause')
        )
      );

      console.log(`üéÆ ${playerControls.length} contr√¥les lecteur trouv√©s:`);
      playerControls.forEach((ctrl, i) => {
        console.log(`   ${i+1}. "${ctrl.text}" ${ctrl.disabled ? '(d√©sactiv√©)' : ''}`);
      });

      // Test des contr√¥les
      for (const control of playerControls.slice(0, 3)) {
        try {
          await page.evaluate((text) => {
            const buttons = Array.from(document.querySelectorAll('button'));
            const btn = buttons.find(b => b.textContent.trim() === text);
            if (btn && !btn.disabled) {
              btn.click();
              return true;
            }
            return false;
          }, control.text);

          console.log(`   ‚úÖ Contr√¥le "${control.text}" test√©`);
          await new Promise(resolve => setTimeout(resolve, 1000));

        } catch (ctrlError) {
          console.log(`   ‚ùå Erreur contr√¥le "${control.text}": ${ctrlError.message}`);
        }
      }

      // Screenshot contr√¥les lecteur
      await page.screenshot({
        path: path.join(screenshotsDir, '10_player_controls.png'),
        fullPage: true
      });

      results.playerControls.push({
        name: 'Contr√¥les Lecteur',
        controlsFound: playerControls.length,
        screenshot: '10_player_controls.png',
        status: 'SUCCESS'
      });

    } catch (playerError) {
      console.log(`‚ùå Erreur contr√¥les lecteur: ${playerError.message}`);
      results.errors.push(`Player: ${playerError.message}`);
    }

    // Test 3: Gestion Playlists
    console.log('\nüéµ Test 3: Gestion Playlists...');

    try {
      await page.goto('http://192.168.1.103/', { waitUntil: 'networkidle2' });
      await new Promise(resolve => setTimeout(resolve, 1000));

      // Naviguer vers section Playlists
      await page.evaluate(() => {
        const links = Array.from(document.querySelectorAll('a, button'));
        const playlistLink = links.find(link =>
          link.textContent.toLowerCase().includes('playlist')
        );
        if (playlistLink) playlistLink.click();
      });

      await new Promise(resolve => setTimeout(resolve, 2000));

      // Identifier √©l√©ments playlist
      const playlistElements = await page.evaluate(() => {
        const elements = [];

        // Boutons playlist
        const buttons = Array.from(document.querySelectorAll('button'));
        buttons.forEach(btn => {
          const text = btn.textContent.trim();
          if (text.toLowerCase().includes('playlist') ||
              text.toLowerCase().includes('nouvelle') ||
              text.toLowerCase().includes('cr√©er') ||
              text.toLowerCase().includes('sauvegarder')) {
            elements.push({
              type: 'button',
              text: text,
              id: btn.id,
              className: btn.className
            });
          }
        });

        // Inputs playlist
        const inputs = Array.from(document.querySelectorAll('input, textarea, select'));
        inputs.forEach(input => {
          if (input.placeholder && (
              input.placeholder.toLowerCase().includes('playlist') ||
              input.placeholder.toLowerCase().includes('nom')
            )) {
            elements.push({
              type: input.type || input.tagName,
              placeholder: input.placeholder,
              id: input.id,
              name: input.name
            });
          }
        });

        return elements;
      });

      console.log(`üìã ${playlistElements.length} √©l√©ments playlist trouv√©s:`);
      playlistElements.forEach((el, i) => {
        console.log(`   ${i+1}. ${el.type}: "${el.text || el.placeholder}" (${el.id || el.className || el.name})`);
      });

      // Test cr√©ation playlist
      try {
        const nameInput = await page.$('input[placeholder*="nom"], input[name*="name"], input[placeholder*="Nom"]');
        if (nameInput) {
          await nameInput.type('Test Playlist Puppeteer');
          console.log('   ‚úÖ Nom playlist saisi');

          const saveBtn = await page.$('button:contains("Sauvegarder"), button:contains("Cr√©er")');
          if (saveBtn) {
            await saveBtn.click();
            console.log('   üíæ Bouton sauvegarder cliqu√©');
            await new Promise(resolve => setTimeout(resolve, 2000));
          }
        }
      } catch (createError) {
        console.log(`   ‚ùå Test cr√©ation: ${createError.message}`);
      }

      // Screenshot playlists
      await page.screenshot({
        path: path.join(screenshotsDir, '11_playlist_management.png'),
        fullPage: true
      });

      results.playlists.push({
        name: 'Gestion Playlists',
        elementsFound: playlistElements.length,
        screenshot: '11_playlist_management.png',
        status: 'SUCCESS'
      });

    } catch (playlistError) {
      console.log(`‚ùå Erreur playlists: ${playlistError.message}`);
      results.errors.push(`Playlists: ${playlistError.message}`);
    }

    // Test 4: Actions Syst√®me
    console.log('\n‚öôÔ∏è Test 4: Actions Syst√®me...');

    try {
      await page.goto('http://192.168.1.103/', { waitUntil: 'networkidle2' });
      await new Promise(resolve => setTimeout(resolve, 1000));

      // Naviguer vers param√®tres
      await page.evaluate(() => {
        const links = Array.from(document.querySelectorAll('a, button'));
        const settingsLink = links.find(link =>
          link.textContent.toLowerCase().includes('param√®tre') ||
          link.textContent.toLowerCase().includes('setting')
        );
        if (settingsLink) settingsLink.click();
      });

      await new Promise(resolve => setTimeout(resolve, 2000));

      // Identifier actions syst√®me
      const systemActions = await page.$$eval('button', buttons =>
        buttons.map(btn => ({
          text: btn.textContent.trim(),
          id: btn.id,
          className: btn.className,
          disabled: btn.disabled
        })).filter(btn =>
          btn.text.toLowerCase().includes('red√©marrer') ||
          btn.text.toLowerCase().includes('√©teindre') ||
          btn.text.toLowerCase().includes('cache') ||
          btn.text.toLowerCase().includes('service') ||
          btn.text.toLowerCase().includes('mise √† jour')
        )
      );

      console.log(`üîß ${systemActions.length} actions syst√®me trouv√©es:`);
      systemActions.forEach((action, i) => {
        console.log(`   ${i+1}. "${action.text}" ${action.disabled ? '(d√©sactiv√©)' : ''}`);
      });

      // Screenshot param√®tres syst√®me
      await page.screenshot({
        path: path.join(screenshotsDir, '12_system_actions.png'),
        fullPage: true
      });

      results.systemActions.push({
        name: 'Actions Syst√®me',
        actionsFound: systemActions.length,
        screenshot: '12_system_actions.png',
        status: 'SUCCESS'
      });

    } catch (systemError) {
      console.log(`‚ùå Erreur actions syst√®me: ${systemError.message}`);
      results.errors.push(`System: ${systemError.message}`);
    }

    // Test 5: Stats et Monitoring
    console.log('\nüìä Test 5: Stats Syst√®me...');

    try {
      await page.goto('http://192.168.1.103/', { waitUntil: 'networkidle2' });
      await new Promise(resolve => setTimeout(resolve, 2000));

      // Analyser les stats affich√©es
      const statsInfo = await page.evaluate(() => {
        const stats = [];

        // Chercher √©l√©ments avec des chiffres/pourcentages
        const elements = Array.from(document.querySelectorAll('*'));
        elements.forEach(el => {
          const text = el.textContent.trim();
          if (text.match(/\d+%|\d+\.\d+|CPU|RAM|Disk|Temperature|¬∞C/i) && text.length < 100) {
            stats.push({
              element: el.tagName,
              text: text,
              className: el.className
            });
          }
        });

        return stats.slice(0, 20); // Limiter √† 20 premiers
      });

      console.log(`üìà ${statsInfo.length} statistiques trouv√©es:`);
      statsInfo.forEach((stat, i) => {
        console.log(`   ${i+1}. ${stat.text}`);
      });

      results.keyFunctionalities.push({
        name: 'Stats Syst√®me',
        statsFound: statsInfo.length,
        stats: statsInfo,
        status: 'SUCCESS'
      });

    } catch (statsError) {
      console.log(`‚ùå Erreur stats: ${statsError.message}`);
      results.errors.push(`Stats: ${statsError.message}`);
    }

  } catch (error) {
    console.error('‚ùå Erreur globale test fonctionnalit√©s:', error);
    results.errors.push(`Global: ${error.message}`);
  }

  // Sauvegarder rapport
  fs.writeFileSync(
    path.join(screenshotsDir, 'rapport_test_4_fonctionnalites.json'),
    JSON.stringify(results, null, 2)
  );

  console.log('\nüéØ R√âSUM√â TEST 4 (Fonctionnalit√©s Cl√©s):');
  console.log(`üì§ Upload: ${results.uploads.length} tests`);
  console.log(`‚ñ∂Ô∏è Contr√¥les lecteur: ${results.playerControls.length} tests`);
  console.log(`üéµ Playlists: ${results.playlists.length} tests`);
  console.log(`‚öôÔ∏è Actions syst√®me: ${results.systemActions.length} tests`);
  console.log(`üìä Fonctionnalit√©s cl√©s: ${results.keyFunctionalities.length} tests`);
  console.log(`‚ùå Erreurs: ${results.errors.length}`);

  await browser.close();
})();