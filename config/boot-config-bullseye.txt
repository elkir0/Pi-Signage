# =============================================================================
# Configuration /boot/config.txt optimisée pour PiSignage
# Raspberry Pi 4 + Bullseye + Chromium GPU Hardware Acceleration
# =============================================================================
# Version: 1.0.0
# Date: 22/09/2025
# Objectif: 30+ FPS stable en lecture vidéo 720p
#
# INSTRUCTIONS D'INSTALLATION:
# 1. Sauvegarder: sudo cp /boot/config.txt /boot/config.txt.backup
# 2. Copier: sudo cp /opt/pisignage/config/boot-config-bullseye.txt /boot/config.txt
# 3. Redémarrer: sudo reboot
# =============================================================================

# -----------------------------------------------------------------------------
# CONFIGURATION MÉMOIRE GPU (CRITIQUE)
# -----------------------------------------------------------------------------
# 128MB recommandé pour équilibre performance/stabilité
# 256MB peut causer des problèmes sur certains Pi 4
gpu_mem=128

# Split mémoire pour compatibilité (si gpu_mem ne fonctionne pas)
# gpu_mem_256=128
# gpu_mem_512=128
# gpu_mem_1024=128

# -----------------------------------------------------------------------------
# PILOTES GPU POUR BULLSEYE (VC4-FKMS-V3D REQUIS)
# -----------------------------------------------------------------------------
# ATTENTION: vc4-kms-v3d cause des problèmes sur Bullseye
# Utiliser OBLIGATOIREMENT vc4-fkms-v3d
dtoverlay=vc4-fkms-v3d

# Activer DRM (Direct Rendering Manager)
dtparam=audio=on
dtparam=i2c_arm=on
dtparam=spi=on

# -----------------------------------------------------------------------------
# OPTIMISATIONS VIDÉO POUR CHROMIUM
# -----------------------------------------------------------------------------
# Force la sortie HDMI (évite l'auto-détection)
hdmi_force_hotplug=1
hdmi_drive=2

# Configuration résolution et fréquence optimales
hdmi_group=2
hdmi_mode=82        # 1920x1080 60Hz
# Alternatives 720p si besoin:
# hdmi_mode=85      # 1280x720 60Hz

# Timing HDMI optimisé
config_hdmi_boost=4
hdmi_pixel_freq_limit=400000000

# -----------------------------------------------------------------------------
# OPTIMISATIONS PERFORMANCES CPU
# -----------------------------------------------------------------------------
# Overclocking modéré pour Pi 4 (sans warranty void)
arm_freq=1750       # CPU à 1.75GHz (au lieu de 1.5GHz)
gpu_freq=600        # GPU à 600MHz (au lieu de 500MHz)
over_voltage=2      # Tension légèrement augmentée pour stabilité

# Configuration mémoire système
sdram_freq=3200
sdram_schmoo=0x02000020
over_voltage_sdram_p=6
over_voltage_sdram_i=4
over_voltage_sdram_c=4

# -----------------------------------------------------------------------------
# GESTION THERMIQUE
# -----------------------------------------------------------------------------
# Limite température pour éviter throttling (85°C par défaut)
temp_limit=80

# Configuration du ventilateur (si présent)
dtoverlay=gpio-fan,gpiopin=14,temp=65000

# -----------------------------------------------------------------------------
# OPTIMISATIONS POUR LECTURE MÉDIA
# -----------------------------------------------------------------------------
# Codec H.264 hardware
gpu_codec_h264=enabled

# Codec H.265/HEVC (Pi 4 seulement)
gpu_codec_h265=enabled

# Allocation mémoire CMA pour le GPU
cma_lwm=16
cma_hwm=32
cma_offline_start=16

# -----------------------------------------------------------------------------
# PARAMÈTRES AUDIO/VIDÉO
# -----------------------------------------------------------------------------
# Forcer l'audio via HDMI
hdmi_drive=2
audio_pwm_mode=2

# Optimisations DMA
dmachans=0x7f35

# -----------------------------------------------------------------------------
# DÉSACTIVER FONCTIONNALITÉS NON NÉCESSAIRES
# -----------------------------------------------------------------------------
# Désactiver Bluetooth (économie énergie/performance)
dtoverlay=disable-bt

# Désactiver WiFi si Ethernet utilisé
# dtoverlay=disable-wifi

# Désactiver caméra si non utilisée
start_x=0
camera_auto_detect=0

# Désactiver splash screen
disable_splash=1

# -----------------------------------------------------------------------------
# OPTIMISATIONS BOOT
# -----------------------------------------------------------------------------
# Boot plus rapide
boot_delay=0
disable_overscan=1

# Réduire les messages de boot
avoid_warnings=1
kernel_old=1

# -----------------------------------------------------------------------------
# PARAMÈTRES EXPÉRIMENTAUX GPU
# -----------------------------------------------------------------------------
# Force l'utilisation du GPU VideoCore VI
# (décommentez si problèmes de détection)
# force_turbo=1
# initial_turbo=30

# Optimisation pipeline GPU
# gpu_split=76

# Configuration avancée VC4
# vc4.enable_dsi=0
# vc4.enable_hdmi=1

# -----------------------------------------------------------------------------
# DEBUG ET MONITORING (À DÉSACTIVER EN PRODUCTION)
# -----------------------------------------------------------------------------
# Logs GPU détaillés (décommentez pour debug)
# gpu_debug=1
# vc_debug=1

# Monitoring température
# dtparam=watchdog=on

# -----------------------------------------------------------------------------
# CONFIGURATION 64-BIT (Si OS 64-bit utilisé)
# -----------------------------------------------------------------------------
# Kernel 64-bit (décommentez si Raspberry Pi OS 64-bit)
# arm_64bit=1

# -----------------------------------------------------------------------------
# NOTES IMPORTANTES
# -----------------------------------------------------------------------------
# 1. REDÉMARRAGE OBLIGATOIRE après modification
# 2. Vérifier avec: vcgencmd get_mem gpu
# 3. Vérifier température: vcgencmd measure_temp
# 4. Vérifier throttling: vcgencmd get_throttled
# 5. En cas de problème, restaurer: sudo cp /boot/config.txt.backup /boot/config.txt
#
# COMMANDES DE VÉRIFICATION POST-REBOOT:
# vcgencmd get_mem gpu          # Doit afficher 128M
# ls /dev/dri/                  # Doit contenir card0
# vcgencmd measure_temp         # Température < 80°C
# vcgencmd get_throttled        # Doit afficher 0x0
# glxinfo | grep -i vendor     # Vérifier Broadcom VideoCore
#
# DÉPANNAGE:
# - Si écran noir: hdmi_safe=1 (temporaire)
# - Si ralentissements: réduire arm_freq à 1500
# - Si surchauffe: ajouter ventilateur ou radiateur
# - Si instabilité: réduire over_voltage à 1
#
# =============================================================================