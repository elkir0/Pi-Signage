# Configuration nginx pour Pi Signage Web Interface
# À placer dans /etc/nginx/sites-available/pi-signage

server {
    listen 80 default_server;
    listen [::]:80 default_server;
    
    # Nom du serveur
    server_name _;
    
    # Racine du site
    root /var/www/pi-signage;
    
    # Index
    index index.php index.html;
    
    # Logs
    access_log /var/log/nginx/pi-signage.access.log;
    error_log /var/log/nginx/pi-signage.error.log;
    
    # Taille max upload (pour les vidéos)
    client_max_body_size 500M;
    client_body_timeout 300s;
    
    # Sécurité - Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Gestion des fichiers statiques
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Bloquer l'accès aux fichiers sensibles
    location ~ /\. {
        deny all;
    }
    
    location ~ /includes/ {
        deny all;
    }
    
    location ~ /temp/ {
        deny all;
    }
    
    # PHP
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    location ~ \.php$ {
        # Vérifier que le fichier existe
        try_files $uri =404;
        
        # FastCGI
        fastcgi_pass unix:/run/php/php8.2-fpm-pi-signage.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        
        # Timeouts pour les longs téléchargements
        fastcgi_read_timeout 300s;
        fastcgi_send_timeout 300s;
    }
    
    # API endpoints avec support SSE
    location ~ ^/api/ {
        # Headers pour Server-Sent Events
        add_header Cache-Control "no-cache";
        add_header X-Accel-Buffering "no";
        
        try_files $uri $uri/ =404;
        
        location ~ \.php$ {
            fastcgi_pass unix:/run/php/php8.2-fpm-pi-signage.sock;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            include fastcgi_params;
            
            # Désactiver la mise en buffer pour SSE
            fastcgi_buffering off;
            fastcgi_keep_conn on;
        }
    }
}
