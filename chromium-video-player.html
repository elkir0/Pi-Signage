<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PiSignage - Chromium Optimized Video Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        #video-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #main-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* Force hardware acceleration */
            transform: translateZ(0);
            will-change: transform;
            /* Optimize for GPU */
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            -webkit-perspective: 1000;
            perspective: 1000;
        }

        #status-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: #0f0;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-family: monospace;
            z-index: 1000;
            display: none; /* Caché par défaut */
        }

        #error-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,0,0,0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
            z-index: 2000;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div id="video-container">
        <div class="loading" id="loading">Chargement de la vidéo optimisée...</div>

        <video
            id="main-video"
            preload="auto"
            muted
            loop
            playsinline
            webkit-playsinline
            autoplay
            style="display: none;"
        >
            <source src="media/demo.mp4" type="video/mp4">
            <source src="media/demo.webm" type="video/webm">
            Votre navigateur ne supporte pas la lecture vidéo HTML5.
        </video>

        <div id="status-overlay">
            <div>FPS: <span id="fps-counter">--</span></div>
            <div>Résolution: <span id="resolution">--</span></div>
            <div>Codec: <span id="codec-info">--</span></div>
            <div>GPU: <span id="gpu-status">--</span></div>
            <div>Buffering: <span id="buffer-status">--</span></div>
        </div>

        <div id="error-overlay">
            <h3>Erreur de lecture vidéo</h3>
            <p id="error-message">--</p>
            <button onclick="retryVideo()">Réessayer</button>
            <button onclick="enableFallback()">Mode fallback</button>
        </div>
    </div>

    <script>
        // Configuration pour optimisation GPU
        const CONFIG = {
            targetFPS: 30,
            maxRetries: 3,
            fallbackEnabled: false,
            debugMode: localStorage.getItem('pisignage-debug') === 'true'
        };

        let video = null;
        let retryCount = 0;
        let fpsCounter = 0;
        let lastFrameTime = 0;
        let statusVisible = CONFIG.debugMode;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            video = document.getElementById('main-video');
            initializeVideo();
            setupEventListeners();
            setupPerformanceMonitoring();

            // Toggle debug avec Ctrl+D
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'd') {
                    toggleDebugMode();
                }
            });
        });

        function initializeVideo() {
            console.log('[PiSignage] Initialisation du lecteur vidéo optimisé GPU');

            // Détection des capacités GPU
            detectGPUCapabilities();

            // Configuration des événements vidéo
            video.addEventListener('loadstart', onLoadStart);
            video.addEventListener('loadedmetadata', onMetadataLoaded);
            video.addEventListener('canplay', onCanPlay);
            video.addEventListener('playing', onPlaying);
            video.addEventListener('error', onVideoError);
            video.addEventListener('stalled', onStalled);
            video.addEventListener('waiting', onWaiting);
            video.addEventListener('progress', onProgress);

            // Forcer le chargement
            video.load();
        }

        function detectGPUCapabilities() {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');

            if (gl) {
                const renderer = gl.getParameter(gl.RENDERER);
                const vendor = gl.getParameter(gl.VENDOR);
                console.log(`[GPU] Renderer: ${renderer}, Vendor: ${vendor}`);
                updateStatus('gpu-status', renderer.includes('VideoCore') ? 'VideoCore VI' : 'Software');
            } else {
                console.warn('[GPU] WebGL non disponible - fallback software');
                updateStatus('gpu-status', 'Software');
            }
        }

        function onLoadStart() {
            console.log('[Video] Début du chargement');
            updateStatus('buffer-status', 'Chargement...');
        }

        function onMetadataLoaded() {
            console.log(`[Video] Métadonnées: ${video.videoWidth}x${video.videoHeight}`);
            updateStatus('resolution', `${video.videoWidth}x${video.videoHeight}`);

            // Détection du codec
            if (video.currentSrc.includes('.mp4')) {
                updateStatus('codec-info', 'H.264/MP4');
            } else if (video.currentSrc.includes('.webm')) {
                updateStatus('codec-info', 'VP8/WebM');
            }
        }

        function onCanPlay() {
            console.log('[Video] Prêt pour lecture');
            document.getElementById('loading').style.display = 'none';
            video.style.display = 'block';
            updateStatus('buffer-status', 'Prêt');
        }

        function onPlaying() {
            console.log('[Video] Lecture démarrée');
            updateStatus('buffer-status', 'Lecture');

            // Optimisations runtime pour GPU
            optimizeForGPU();
        }

        function onVideoError(e) {
            console.error('[Video] Erreur:', e);
            const error = video.error;
            let message = 'Erreur inconnue';

            if (error) {
                switch(error.code) {
                    case MediaError.MEDIA_ERR_ABORTED:
                        message = 'Lecture interrompue';
                        break;
                    case MediaError.MEDIA_ERR_NETWORK:
                        message = 'Erreur réseau';
                        break;
                    case MediaError.MEDIA_ERR_DECODE:
                        message = 'Erreur de décodage - GPU non compatible';
                        break;
                    case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:
                        message = 'Format non supporté';
                        break;
                }
            }

            showError(message);

            if (retryCount < CONFIG.maxRetries) {
                setTimeout(retryVideo, 2000);
            } else {
                enableFallback();
            }
        }

        function onStalled() {
            console.warn('[Video] Lecture bloquée');
            updateStatus('buffer-status', 'Bloqué');
        }

        function onWaiting() {
            console.warn('[Video] En attente de données');
            updateStatus('buffer-status', 'Buffering');
        }

        function onProgress() {
            if (video.buffered.length > 0) {
                const buffered = (video.buffered.end(0) / video.duration) * 100;
                updateStatus('buffer-status', `${Math.round(buffered)}%`);
            }
        }

        function optimizeForGPU() {
            // Forcer l'accélération GPU via CSS transforms
            video.style.transform = 'translateZ(0) scale(1.0001)';

            // Optimisation mémoire vidéo
            if (video.videoWidth > 1280) {
                console.warn('[GPU] Résolution élevée détectée - optimisation...');
                video.style.imageRendering = 'optimizeSpeed';
            }

            // Préchargement du buffer
            video.currentTime = 0;
        }

        function setupPerformanceMonitoring() {
            let frameCount = 0;
            let lastTime = performance.now();

            function measureFPS() {
                const now = performance.now();
                frameCount++;

                if (now - lastTime >= 1000) {
                    const fps = Math.round((frameCount * 1000) / (now - lastTime));
                    updateStatus('fps-counter', fps);

                    // Alerte si FPS faible
                    if (fps < CONFIG.targetFPS * 0.8) {
                        console.warn(`[Performance] FPS faible: ${fps}/${CONFIG.targetFPS}`);
                    }

                    frameCount = 0;
                    lastTime = now;
                }

                if (video && !video.paused) {
                    requestAnimationFrame(measureFPS);
                }
            }

            video.addEventListener('playing', () => {
                requestAnimationFrame(measureFPS);
            });
        }

        function setupEventListeners() {
            // Gestion du plein écran
            document.addEventListener('fullscreenchange', function() {
                if (document.fullscreenElement) {
                    console.log('[Display] Mode plein écran activé');
                } else {
                    console.log('[Display] Mode plein écran désactivé');
                }
            });

            // Gestion de la visibilité
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    console.log('[Display] Page cachée - pause potentielle');
                } else {
                    console.log('[Display] Page visible - reprise');
                    if (video.paused) {
                        video.play().catch(console.error);
                    }
                }
            });
        }

        function retryVideo() {
            retryCount++;
            console.log(`[Retry] Tentative ${retryCount}/${CONFIG.maxRetries}`);

            hideError();
            document.getElementById('loading').style.display = 'block';
            video.style.display = 'none';

            // Reset et rechargement
            video.currentTime = 0;
            video.load();
        }

        function enableFallback() {
            console.log('[Fallback] Activation du mode de compatibilité');
            CONFIG.fallbackEnabled = true;

            // Désactiver l'accélération GPU
            video.style.transform = 'none';
            video.style.willChange = 'auto';

            // Réduire la qualité si possible
            const sources = video.querySelectorAll('source');
            sources.forEach(source => {
                if (source.src.includes('720p')) {
                    source.src = source.src.replace('720p', '480p');
                }
            });

            hideError();
            retryVideo();
        }

        function toggleDebugMode() {
            statusVisible = !statusVisible;
            document.getElementById('status-overlay').style.display = statusVisible ? 'block' : 'none';
            localStorage.setItem('pisignage-debug', statusVisible.toString());
            console.log(`[Debug] Mode debug: ${statusVisible ? 'ON' : 'OFF'}`);
        }

        function updateStatus(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-overlay').style.display = 'block';
        }

        function hideError() {
            document.getElementById('error-overlay').style.display = 'none';
        }

        // API externe pour contrôle depuis scripts
        window.PiSignagePlayer = {
            play: () => video.play(),
            pause: () => video.pause(),
            restart: () => { video.currentTime = 0; video.play(); },
            toggleDebug: toggleDebugMode,
            getStats: () => ({
                fps: parseInt(document.getElementById('fps-counter').textContent) || 0,
                resolution: document.getElementById('resolution').textContent,
                gpu: document.getElementById('gpu-status').textContent,
                buffering: document.getElementById('buffer-status').textContent
            })
        };

        console.log('[PiSignage] Lecteur vidéo optimisé GPU initialisé');
    </script>
</body>
</html>