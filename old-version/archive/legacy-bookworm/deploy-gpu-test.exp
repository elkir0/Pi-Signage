#!/usr/bin/expect -f

set timeout 30
set password "palmer00"

# Copier les scripts
spawn scp test-gpu-chromium.sh /tmp/launch-gpu-chromium.sh pi@192.168.1.103:/tmp/
expect {
    "yes/no" { send "yes\r"; exp_continue }
    "password:" { send "$password\r" }
}
expect eof

# Se connecter et exécuter
spawn ssh pi@192.168.1.103
expect {
    "password:" { send "$password\r" }
}
expect "$ "

# Préparer l'environnement
send "cd /tmp\r"
expect "$ "

send "chmod +x launch-gpu-chromium.sh test-gpu-chromium.sh\r"
expect "$ "

# Vérifier si on a une vidéo de test
send "ls -la /opt/pisignage/videos/\r"
expect "$ "

# Si pas de vidéo, en télécharger une
send "if \[ ! -f /opt/pisignage/videos/test_video.mp4 \]; then\r"
expect "> "
send "  sudo mkdir -p /opt/pisignage/videos\r"
expect "> "
send "  cd /opt/pisignage/videos\r"
expect "> "
send "  sudo wget -O test_video.mp4 'https://test-videos.co.uk/vids/bigbuckbunny/mp4/h264/720/Big_Buck_Bunny_720_10s_1MB.mp4'\r"
expect "> "
send "fi\r"
expect "$ "

# Créer le player HTML
send "sudo bash /tmp/test-gpu-chromium.sh\r"
expect "$ "

# Vérifier l'environnement GPU
send "echo '=== GPU Check ==='\r"
expect "$ "

send "lsmod | grep -E 'v3d|vc4' | head -5\r"
expect "$ "

send "vcgencmd get_mem gpu\r"
expect "$ "

# Lancer le test avec monitoring
send "echo '=== Lancement test GPU + Chromium ==='\r"
expect "$ "

send "export DISPLAY=:0\r"
expect "$ "

send "# Tuer les instances existantes\r"
expect "$ "
send "pkill -f chromium || true\r"
expect "$ "

send "# Lancer en arrière-plan avec monitoring\r"
expect "$ "
send "nohup /tmp/launch-gpu-chromium.sh > /tmp/chromium-gpu.log 2>&1 &\r"
expect "$ "

send "sleep 5\r"
expect "$ "

# Monitorer les performances
send "echo '=== Monitoring Performance ==='\r"
expect "$ "

send "ps aux | grep chromium | head -3\r"
expect "$ "

send "top -bn1 | head -15\r"
expect "$ "

# Vérifier les logs
send "echo '=== GPU Logs ==='\r"
expect "$ "
send "tail -20 /tmp/chromium-gpu.log\r"
expect "$ "

send "tail -10 /tmp/gpu-chromium-test.log\r"
expect "$ "

# Rester connecté pour observation
interact