# =Â Index Complet - Mémoire PiSignage v0.8.0
Généré le : 2025-09-22 15:38:01

---
## =Ä activeContext

# =Í Contexte Actif - PiSignage v0.8.0

## = État actuel (22/09/2025 - 15:25)

### Environnement de travail
- **Machine actuelle** : VM de développement Linux
- **Répertoire de travail** : `/opt/pisignage`
- **Version active** : v0.8.0 (SEULE VERSION OFFICIELLE)
- **Plateforme** : Linux 6.12.43+deb13-amd64

### État du déploiement
-  **Local** : v0.8.0 complète dans `/opt/pisignage`
-  **GitHub** : UNIQUEMENT v0.8.0 (force pushed, nettoyé)
- ó **Production (192.168.1.103)** : En attente de déploiement

### Dernières actions effectuées
1. **Rollback complet** de toutes versions > v0.8.0
2. **Nettoyage GitHub** : Suppression totale + force push v0.8.0
3. **Validation locale** : 50 occurrences v0.8.0 confirmées
4. **Scripts prêts** : Déploiement automatisé disponible

## <¯ Focus actuel

### Migration en cours
- **ACTUELLEMENT** : Migration du système de mémoire vers architecture multi-fichiers MCP
- **Création** : Structure `.claude/memory-bank/` avec fichiers contextuels séparés
- **Objectif** : Améliorer la persistance et l'organisation de la mémoire du projet

### Prochaine action immédiate
- ó Finir création des fichiers de contexte (progress.md)
- ó Ajouter pattern récursif en haut de CLAUDE.md
- ó Créer script de synchronisation
- ó Initialiser MCP memory

## =' Problèmes connus à résoudre

### Production
1. **Cache nginx persistant** sur Raspberry Pi
   - Solution : Vider avec `sudo rm -rf /var/cache/nginx/*`

2. **Version incorrecte affichée**
   - Cause : Anciens fichiers non supprimés
   - Solution : Déploiement complet v0.8.0

### Technique
1. **Upload limité** dans certaines configurations
   - Workaround : Utiliser SCP pour gros fichiers

2. **YouTube download** peut échouer
   - Solution : Vérifier yt-dlp à jour

## =Ê Décisions récentes

### Architecture
-  **Choix PHP** : Abandonné Next.js pour PHP stable
-  **Version unique** : v0.8.0 seule version maintenue
-  **GitHub propre** : Une seule branche, un seul tag

### Process
-  **Automatisation** : Je fais tout, pas l'utilisateur
-  **Tests systématiques** : 2 Puppeteer minimum
-  **Documentation continue** : CLAUDE.md toujours à jour

## =€ Commandes prêtes à l'emploi

### Déploiement immédiat
```bash
# Option 1 : Script tout-en-un
/opt/pisignage/deploy-v080-to-production.sh

# Option 2 : Commandes manuelles
sshpass -p 'raspberry' rsync -avz --delete /opt/pisignage/ pi@192.168.1.103:/opt/pisignage/
sshpass -p 'raspberry' ssh pi@192.168.1.103 'sudo systemctl restart nginx php8.2-fpm'
```

### Vérification rapide
```bash
# Check version locale
cat /opt/pisignage/VERSION

# Check version production
sshpass -p 'raspberry' ssh pi@192.168.1.103 'cat /opt/pisignage/VERSION'

# Test API production
curl -s http://192.168.1.103/api/system.php | jq .version
```

## <¬ Historique de la session actuelle

### Ce qui a été tenté aujourd'hui
1. **Matin** : Échec Next.js v2.0.1
2. **13h** : Migration PHP v0.8.0
3. **14h** : Tentative rollback v0.9.4
4. **14h45** : VRAI rollback ’ renommage v0.8.0
5. **15h15** : Nettoyage GitHub total
6. **15h25** : État stable v0.8.0 prêt
7. **MAINTENANT** : Migration système mémoire vers MCP

### Leçons apprises
- Cache nginx = ennemi principal
- Tests Puppeteer peuvent mentir
- Force push = seule solution propre
- v0.8.0 = version définitive

## =Ý Notes pour la prochaine session

### À faire en priorité
1. Finir migration mémoire MCP
2. Déployer v0.8.0 sur Pi
3. Valider avec 2 tests Puppeteer
4. Confirmer succès à l'utilisateur

### À ne pas oublier
- IP correcte : 192.168.1.103
- Vider cache avant tests
- Je fais tout moi-même
- Documenter dans CLAUDE.md

## = Accès et credentials

```yaml
Production:
  IP: 192.168.1.103
  User: pi
  Password: raspberry

GitHub:
  Repo: https://github.com/elkir0/Pi-Signage
  Branch: main
  Tag: v0.8.0

Services:
  Nginx: Port 80
  PHP: 8.2-fpm
  VLC: Contrôle par scripts
```

---
*Contexte actif mis à jour : 22/09/2025 - Session de migration mémoire MCP*
---
## =Ä progress

# =È Progression et TODOs - PiSignage v0.8.0

##  Tâches complétées

### Infrastructure (100%)
-  Architecture PHP v0.8.0 créée
-  Structure de fichiers complète
-  APIs REST fonctionnelles
-  Scripts bash de contrôle
-  Configuration nginx/PHP

### Nettoyage versions (100%)
-  Suppression versions > v0.8.0
-  Renommage v0.9.4 ’ v0.8.0
-  GitHub nettoyé (force push)
-  50 occurrences v0.8.0 validées
-  Scripts de déploiement prêts

### Documentation (100%)
-  README.md créé
-  CLAUDE.md maintenu à jour
-  Commentaires code PHP
-  Documentation APIs

### Migration mémoire MCP (60%)
-  Structure .claude/memory-bank créée
-  projectBrief.md créé
-  techContext.md créé
-  systemPatterns.md créé
-  activeContext.md créé
-  progress.md créé
- ó Pattern récursif à ajouter dans CLAUDE.md
- ó Script sync-memory.sh à créer
- ó Initialisation MCP memory
- ó CHECK.md de validation

## = Tâches en cours

### Déploiement production
- ó Déployer v0.8.0 sur Raspberry Pi (192.168.1.103)
- ó Vider cache nginx production
- ó Exécuter 2 tests Puppeteer
- ó Valider interface accessible

### Migration système mémoire
- ó Finaliser pattern récursif CLAUDE.md
- ó Créer script synchronisation
- ó Initialiser base MCP
- ó Tester recherche MCP

## =Ë TODO List prioritaire

### =4 Urgent (à faire maintenant)
1. [ ] Finir migration mémoire MCP
2. [ ] Ajouter pattern récursif en haut de CLAUDE.md
3. [ ] Créer script sync-memory.sh
4. [ ] Initialiser MCP avec contextes

### =à Important (aujourd'hui)
1. [ ] Déployer v0.8.0 sur Pi production
2. [ ] Vider cache nginx complètement
3. [ ] Lancer 2 tests Puppeteer minimum
4. [ ] Confirmer version affichée = v0.8.0

### =á Normal (cette semaine)
1. [ ] Optimiser performances PHP
2. [ ] Améliorer gestion erreurs APIs
3. [ ] Ajouter logs détaillés
4. [ ] Documenter processus de backup

### =â Nice to have (plus tard)
1. [ ] Interface d'admin améliorée
2. [ ] Statistiques d'usage
3. [ ] Support multi-écrans
4. [ ] App mobile de contrôle

## = Bugs connus

### Critiques
-   Cache nginx persistant sur Pi
  - **Impact** : Version incorrecte affichée
  - **Solution** : `sudo rm -rf /var/cache/nginx/*`
  - **Status** : À corriger au déploiement

### Mineurs
- Upload peut timeout sur gros fichiers (>50MB)
  - **Workaround** : Utiliser SCP
  - **Fix prévu** : Augmenter timeout PHP

- YouTube download parfois lent
  - **Cause** : yt-dlp pas optimisé
  - **Solution** : Mettre à jour yt-dlp

## <¯ Prochaines étapes immédiates

```bash
# 1. Finir migration mémoire (EN COURS)
- Ajouter pattern récursif CLAUDE.md
- Créer sync-memory.sh
- Initialiser MCP

# 2. Déployer sur production
/opt/pisignage/deploy-v080-to-production.sh

# 3. Vider cache et tester
ssh pi@192.168.1.103 'sudo rm -rf /var/cache/nginx/*'
ssh pi@192.168.1.103 'sudo systemctl restart nginx php8.2-fpm'

# 4. Valider avec Puppeteer
node test-production-v080.js
```

## =Ê Métriques de progression

### Projet global
- **Complétion** : 85%
- **Version stable** : v0.8.0
- **Tests passés** : Local , Production ó

### Par module
| Module | Status | Progression |
|--------|--------|------------|
| Backend PHP |  Stable | 100% |
| APIs REST |  Fonctionnel | 100% |
| Interface web |  Basique | 100% |
| Scripts bash |  Complet | 100% |
| Déploiement | ó En attente | 75% |
| Tests | ó À faire | 50% |
| Migration MCP | ó En cours | 60% |

## = Tests à effectuer

### Tests unitaires
- [x] API system.php répond
- [x] API media.php liste fichiers
- [x] API playlist.php charge config
- [ ] API screenshot.php capture écran
- [ ] API youtube.php télécharge vidéo

### Tests d'intégration
- [x] Interface charge correctement
- [ ] Upload fichier fonctionne
- [ ] Playlist se met à jour
- [ ] VLC lit les médias
- [ ] Logs sont créés

### Tests de production
- [ ] Accès HTTP 200 sur 192.168.1.103
- [ ] Version affichée = v0.8.0
- [ ] 5 APIs minimum répondent
- [ ] Performance < 1 seconde
- [ ] Erreurs console < 5

## =Ý Notes de développement

### Décisions techniques
- **PHP choisi** car plus stable que Next.js pour ce projet
- **v0.8.0** pour éviter confusion avec anciennes versions
- **Nginx** pour performance sur Raspberry Pi
- **VLC** pour compatibilité maximale médias

### Améliorations futures envisagées
1. WebSocket pour contrôle temps réel
2. Dashboard analytics
3. Support HTTPS avec Let's Encrypt
4. Clustering multi-Pi
5. CDN pour médias volumineux

## ¡ Commandes utiles rappel

```bash
# Status rapide
curl -s http://192.168.1.103/api/system.php | jq

# Logs temps réel
ssh pi@192.168.1.103 'tail -f /opt/pisignage/logs/system.log'

# Restart complet
ssh pi@192.168.1.103 'sudo systemctl restart nginx php8.2-fpm && sudo pkill vlc && /opt/pisignage/scripts/vlc-control.sh start'

# Backup rapide
ssh pi@192.168.1.103 'tar czf /tmp/pisignage-backup.tar.gz /opt/pisignage'
```

---
*Dernière mise à jour progression : 22/09/2025 - Migration MCP 60%*
*Prochaine action : Finaliser migration mémoire*
---
## =Ä projectBrief

# ðŸ“º PiSignage - Affichage Digital sur Raspberry Pi

## Description du projet
PiSignage est un systÃ¨me d'affichage digital (digital signage) conÃ§u pour Raspberry Pi, permettant de diffuser des contenus multimÃ©dias (vidÃ©os, images) en boucle sur un Ã©cran. Version stable officielle : v0.8.0.

## Objectifs principaux
- âœ… Lecture en boucle de vidÃ©os et images via VLC
- âœ… Interface web de gestion accessible Ã  distance
- âœ… APIs pour le contrÃ´le du systÃ¨me
- âœ… Gestion de playlists personnalisables
- âœ… TÃ©lÃ©chargement de vidÃ©os YouTube
- âœ… Capture d'Ã©cran du contenu affichÃ©
- âœ… Configuration flexible

## Stack technique
- **Backend** : PHP 8.2 (version stable aprÃ¨s migration depuis Next.js)
- **Serveur web** : Nginx
- **Lecteur mÃ©dia** : VLC
- **SystÃ¨me** : Raspberry Pi OS
- **Scripts** : Bash pour automatisation
- **APIs** : REST APIs en PHP
- **Interface** : HTML/CSS/JavaScript vanilla

## Architecture globale
```
/opt/pisignage/          # Racine du projet
â”œâ”€â”€ web/                 # Interface web et APIs
â”‚   â”œâ”€â”€ index.php       # Point d'entrÃ©e principal
â”‚   â””â”€â”€ api/            # Endpoints API
â”œâ”€â”€ scripts/            # Scripts systÃ¨me
â”œâ”€â”€ media/              # Stockage des mÃ©dias
â”œâ”€â”€ config/             # Configuration
â””â”€â”€ logs/               # Journalisation
```

## Environnement de production
- **Plateforme** : Raspberry Pi
- **IP Production** : 192.168.1.103
- **Port** : 80 (HTTP)
- **Services actifs** : nginx, php8.2-fpm, vlc

## Ã‰tat actuel
- **Version** : v0.8.0 (SEULE VERSION OFFICIELLE)
- **GitHub** : https://github.com/elkir0/Pi-Signage
- **Status** : PrÃªt pour production, en attente de dÃ©ploiement final sur Raspberry Pi
---
## =Ä systemPatterns

# <¯ Patterns et Règles Système - PiSignage v0.8.0

##   RÈGLES ABSOLUES (HARDCODÉES)

### 1. MON RÔLE
- **JE fais TOUT** : L'utilisateur ne doit pas avoir à exécuter de commandes
- **Automatisation complète** : Scripts et déploiements automatisés
- **Validation systématique** : Toujours vérifier le résultat

### 2. IP CORRECTE
- **TOUJOURS** : 192.168.1.103
- **JAMAIS** : 192.168.0.103 (ancienne IP erronée)
- **Vérifier** : Toujours double-vérifier l'IP dans les scripts

### 3. PROTOCOLE DE DÉPLOIEMENT
```
Local ’ GitHub ’ Raspberry Pi ’ 2 tests Puppeteer minimum
```
- **JAMAIS** retourner avant validation complète
- **TOUJOURS** faire 2 tests Puppeteer minimum sur production
- **DOCUMENTER** chaque changement dans CLAUDE.md

### 4. CACHE NGINX
- **VIDER AVANT** chaque test
- **Commande complète** :
```bash
sudo rm -rf /var/cache/nginx/*
sudo rm -rf /tmp/nginx-cache/*
sudo systemctl restart nginx
```

### 5. DOCUMENTATION
- **Tout dans CLAUDE.md** : Chaque changement documenté
- **Mise à jour immédiate** : Pas d'attente

## =Ë Workflow obligatoire

1. **Développer localement** dans `/opt/pisignage`
2. **Tester en local** avec curl ou navigateur
3. **Push sur GitHub** avec tag v0.8.0
4. **Déployer sur Raspberry Pi** via SSH/rsync
5. **Vider cache nginx** complètement
6. **2 tests Puppeteer minimum**
7. **Si échec ’ répéter** jusqu'au succès
8. **Mettre à jour CLAUDE.md**

## =« CE QU'IL NE FAUT JAMAIS FAIRE

### Versions
- **JAMAIS** créer de versions autres que v0.8.0
- **JAMAIS** utiliser v0.9.x ou v2.x.x
- **JAMAIS** mélanger les versions

### Cache
- **JAMAIS** oublier de vider le cache nginx
- **JAMAIS** faire confiance au cache navigateur
- **JAMAIS** tester sans restart nginx

### Tests
- **JAMAIS** valider avec moins de 2 tests Puppeteer
- **JAMAIS** ignorer les erreurs console
- **JAMAIS** accepter une performance > 1s

### GitHub
- **JAMAIS** push sans tag v0.8.0
- **JAMAIS** créer de branches autres que main
- **JAMAIS** garder d'anciennes versions

##  Conventions de codage

### PHP
```php
// Headers CORS toujours présents
header('Access-Control-Allow-Origin: *');
header('Content-Type: application/json');

// Gestion d'erreurs systématique
try {
    // Code
} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(['error' => $e->getMessage()]);
}

// Version toujours v0.8.0
define('VERSION', '0.8.0');
```

### Bash Scripts
```bash
#!/bin/bash
set -e  # Exit on error
set -u  # Exit on undefined variable

# Toujours vérifier les commandes
if ! command -v vlc &> /dev/null; then
    echo "VLC not installed"
    exit 1
fi

# Logs détaillés
echo "[$(date)] Action en cours..."
```

### Structure API
```json
{
  "success": true,
  "data": {},
  "version": "0.8.0",
  "timestamp": "2025-09-22T15:00:00Z"
}
```

## =' Patterns d'implémentation

### Upload de fichiers
1. Vérifier type MIME
2. Limiter taille (100MB max)
3. Générer nom unique
4. Déplacer vers `/media/`
5. Retourner chemin relatif

### Gestion playlists
1. Lire JSON existant
2. Valider structure
3. Merger avec nouveaux items
4. Sauvegarder atomiquement
5. Recharger VLC

### Captures d'écran
1. Vérifier VLC actif
2. Appeler API HTTP VLC
3. Sauvegarder temporairement
4. Convertir si nécessaire
5. Retourner base64 ou URL

## =Ê Standards de qualité

### Performance
- **Temps de réponse API** : < 200ms
- **Chargement page** : < 1s
- **Upload fichier 10MB** : < 10s

### Fiabilité
- **Uptime cible** : 99.9%
- **Recovery time** : < 30s
- **Logs rotation** : Journalière

### Sécurité
- **Validation inputs** : Systématique
- **Escape outputs** : HTML, SQL, Shell
- **Permissions fichiers** : 755 dossiers, 644 fichiers
- **User process** : www-data (jamais root)

## = Patterns de débugging

### Commandes de diagnostic
```bash
# Vérifier services
systemctl status nginx php8.2-fpm

# Vérifier logs
tail -f /var/log/nginx/error.log
tail -f /var/log/php8.2-fpm.log

# Vérifier processus
ps aux | grep vlc
ps aux | grep php

# Vérifier ports
netstat -tlnp | grep :80

# Vérifier espace disque
df -h /opt/pisignage
```

### Tests de validation
```bash
# Test API local
curl -I http://localhost/api/system.php

# Test API production
curl -I http://192.168.1.103/api/system.php

# Test version
curl http://192.168.1.103/api/system.php | jq .version
```

## =€ Patterns de déploiement

### Déploiement atomique
```bash
# 1. Backup actuel
ssh pi@192.168.1.103 'cp -r /opt/pisignage /opt/pisignage.backup'

# 2. Sync nouveaux fichiers
rsync -avz --delete /opt/pisignage/ pi@192.168.1.103:/opt/pisignage.tmp/

# 3. Switch atomique
ssh pi@192.168.1.103 'mv /opt/pisignage /opt/pisignage.old && mv /opt/pisignage.tmp /opt/pisignage'

# 4. Restart services
ssh pi@192.168.1.103 'sudo systemctl restart nginx php8.2-fpm'
```

### Rollback rapide
```bash
# Si problème détecté
ssh pi@192.168.1.103 'mv /opt/pisignage /opt/pisignage.failed && mv /opt/pisignage.old /opt/pisignage'
ssh pi@192.168.1.103 'sudo systemctl restart nginx php8.2-fpm'
```

## ¡ Commandes critiques mémorisées

```bash
# SSH vers Pi
sshpass -p 'raspberry' ssh pi@192.168.1.103

# Déploiement complet
/opt/pisignage/deploy-v080-to-production.sh

# Force push GitHub
git push --force origin main
git tag -f v0.8.0
git push --tags --force

# Vider tous les caches
sudo rm -rf /var/cache/nginx/* /tmp/nginx-cache/*
sudo systemctl restart nginx php8.2-fpm

# Vérification rapide
curl -s http://192.168.1.103 | grep -o "v0.8.0"
```
---
## =Ä techContext

# =' Contexte Technique - PiSignage v0.8.0

## Configuration système

### Raspberry Pi Production
- **IP** : 192.168.1.103
- **User** : pi
- **Password** : raspberry
- **OS** : Raspberry Pi OS
- **Services** : nginx, php8.2-fpm
- **Dossier** : /opt/pisignage

### Services et ports
- **Nginx** : Port 80
- **PHP-FPM** : php8.2-fpm (socket Unix)
- **VLC** : Contrôlé via scripts bash

## Structure détaillée des fichiers

```
/opt/pisignage/
   VERSION               # Contient "0.8.0"
   README.md            # Documentation utilisateur
   CLAUDE.md            # Mémoire de contexte AI
   web/
      index.php        # Interface principale PHP
      config.php       # Configuration globale
      api/
          system.php   # Infos système (CPU, RAM, disk)
          media.php    # CRUD médias
          playlist.php # Gestion playlists JSON
          screenshot.php # Capture écran VLC
          youtube.php  # Interface yt-dlp
          upload.php   # Upload fichiers multimédias
   scripts/
      vlc-control.sh   # Start/stop/restart VLC
      screenshot.sh    # Capture via VLC HTTP
      youtube-dl.sh    # Wrapper yt-dlp
   media/               # Stockage vidéos/images
   config/
      playlists.json   # Configuration playlists
   logs/
       system.log       # Logs système
       vlc.log          # Logs VLC
```

## APIs REST disponibles

### Endpoints v0.8.0
- `GET /api/system.php` : Infos système (CPU, mémoire, disque)
- `GET /api/media.php` : Liste des médias
- `POST /api/media.php` : Upload nouveau média
- `DELETE /api/media.php?file=X` : Suppression média
- `GET /api/playlist.php` : Configuration playlist actuelle
- `POST /api/playlist.php` : Mise à jour playlist
- `GET /api/screenshot.php` : Capture écran actuel
- `POST /api/youtube.php` : Téléchargement vidéo YouTube
- `POST /api/upload.php` : Upload direct de fichiers

## Dépendances système

### Packages Linux requis
```bash
nginx
php8.2-fpm
php8.2-cli
php8.2-json
php8.2-curl
vlc
yt-dlp (ou youtube-dl)
sshpass
git
```

### Configuration Nginx
```nginx
server {
    listen 80;
    root /opt/pisignage/web;
    index index.php;

    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }
}
```

## Scripts de déploiement

### Scripts disponibles
- `/opt/pisignage/deploy-v080-to-production.sh` : Déploiement sur Raspberry Pi
- `/opt/pisignage/github-clean-and-push-v080.sh` : Nettoyage et push GitHub
- `/opt/rollback-v080-complete.sh` : Rollback complet vers v0.8.0

### Commandes de déploiement
```bash
# Déploiement sur Pi
sshpass -p 'raspberry' rsync -avz --delete /opt/pisignage/ pi@192.168.1.103:/opt/pisignage/

# Force push GitHub
git push --force origin main
git push --tags --force

# Redémarrage services Pi
ssh pi@192.168.1.103 'sudo systemctl restart nginx php8.2-fpm'
```

## Base de données et stockage

### Stockage des données
- **Médias** : `/opt/pisignage/media/` (vidéos MP4, images JPG/PNG)
- **Playlists** : `/opt/pisignage/config/playlists.json`
- **Configuration** : `/opt/pisignage/web/config.php`
- **Logs** : `/opt/pisignage/logs/`

### Format playlist JSON
```json
{
  "items": [
    {
      "type": "video",
      "path": "/media/video1.mp4",
      "duration": 30
    },
    {
      "type": "image",
      "path": "/media/image1.jpg",
      "duration": 10
    }
  ],
  "loop": true,
  "shuffle": false
}
```

## Tests et validation

### Tests Puppeteer requis
1. **Test basique** : HTTP 200, titre correct, APIs accessibles
2. **Test complet** : Performance < 1s, erreurs console < 5, toutes APIs fonctionnelles

### Commandes de test
```bash
# Test local
curl -I http://localhost/api/system.php

# Test production
curl -I http://192.168.1.103/api/system.php

# Vérification version
ssh pi@192.168.1.103 'cat /opt/pisignage/VERSION'
```

## Cache et optimisation

### Gestion du cache Nginx
```bash
# Vider cache COMPLÈTEMENT
sudo rm -rf /var/cache/nginx/*
sudo rm -rf /tmp/nginx-cache/*
sudo systemctl restart nginx
sudo systemctl restart php8.2-fpm
```

### Optimisations PHP
- `upload_max_filesize = 100M`
- `post_max_size = 100M`
- `max_execution_time = 300`
- `memory_limit = 256M`
